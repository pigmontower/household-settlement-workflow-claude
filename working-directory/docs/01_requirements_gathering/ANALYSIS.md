
# やりたいこと

## 前提
月に一回以下の作業が必要になる
- 私が支払った生活費の内、一部を妻が支払う
そのために妻が支払う分の料金を計算して妻に伝える必要がある

## 改善したい点
前述の前提作業において、以下、不便に感じる点を改善し、
清算フローの利便性を向上させたい

### 不便に感じる点

以下の手作業操作が面倒に感じる

#### 問題点1.個別の金額計算
- 支払いを行った際に、一部が妻負担分、一部が私の負担分、一部が割り勘分がある。それを妻が支払うべき金額を割り出す

#### 問題点2.清算金額計算
- 清算時に、それまでの妻の支払い金額合計を計算

#### 問題点3.合計金額と内訳の伝達
- 計算した内訳と合計を妻にわかりやすく伝える

## 検討している構成
- ワークフロー(n8n？)
- トリガー（Slack? line？）

# 改善案

## 問題点1の改善案

## 案1

### 構成

#### 私の操作
生活費が発生した時点でslackに金額を送信
そのとき、「合計」スタンプ、「単独」スタンプ、「未」スタンプのいずれかを付ける

#### プログラム
上記のslackとトリガーとして、n8nのワークフローを動かす
n8nにて以下の制御を行う
未清算金額変数を作る
金額とスタンプに応じて以下を計算
「合計」スタンプの場合->金額を1/2にした値を変数に入れる
「単独」スタンプの場合->その金額の値を変数に入れる
「未」スタンプの場合->何もしない
未清算金額変数に上記で計算した変数を加算
月末になると、その時点の未清算金額変数を通知
「未」スタンプがついているslackの投稿へのリンクを表示
「未」スタンプがついているslackで金額を確定させると未清算金額変数に加算
「未」スタンプがなくなるまで繰り返す

### 問題点1
> 生活費が発生した時点でslackに金額を送信

この操作自体は手作業。そのため、一回の支払い内での個別金額を漏れなく送信する必要がある
何か、自動化できる部分があればいいが。
画像にマーカーをつけて、マーカーを識別して支払い金額を計算することも検討した。
だが、精度が心配。

### 問題点2
slackは普段あまり使わない。lineのbotを作成できるならそちらの方が便利か

## 案2：LINE + Gemini OCR + インタラクティブ分類（ハイブリッド方式）

### 構成
- **インターフェース**: LINE公式アカウント
- **バックエンド**: n8n
- **解析エンジン**: Gemini 1.5 Flash
- **データ保存**: Google スプレッドシート


#### 【仕分けモード】
1. **ユーザー**：レシート画像を送る
2. **システム**：解析開始を通知
   - 「レシートを読み取っています…」と表示
3. **システム**：1品目目の確認を求める
   - 【品目A：500円】を表示
   - 「残りn品目」ステータスを表示
   - クイックリプライボタンを表示（割り勘、自分、妻、保留、全て割り勘）
4. **ユーザー**：ボタンを押す
5. **システム**：2品目目以降があれば、手順3を繰り返す
6. **システム**：完了報告を表示
   - 今回の「割り勘合計金額」と「スプレッドシートへのリンク」を表示

### 処理フロー
1.  **入力**: 支払い後にレシートの写真をLINEで送信。
2.  **AI解析**: n8n経由でGeminiが品目と金額を抽出し、あわせて「割り勘」「私負担」などの初期分類案を作成。
3.  **ユーザー確認（クイックリプライ）**:
    - LINEに「【品目A: 500円】の分類を選択してください（AI推論：割り勘）」のように届く。
    - 下部に「割り勘」「自分負担」「妻負担」「保留」などのボタンを表示。
    - ユーザーはボタンを押すだけで確定。一括確定ボタンも用意。
4.  **データ蓄積**: 確定金額をスプレッドシートに保存。
5.  **月次集計**: 月末にn8nがシートを集計し、合計額と内訳（スプレッドシートURL）をLINEで通知。

### 案1からの改善点
- **入力負荷の軽減**: 写真を撮るだけで品目・金額の入力が不要に。
- **分類の半自動化**: AIが推論した結果をタップで選ぶだけ。
- **プラットフォーム**: 頻繁に使うLINEで完結。
- **透明性**: スプレッドシートで内訳を夫婦で共有可能。

## 案3：金額訂正ステップ付きハイブリッド方式

### 構成
案2と同様（LINE + n8n + Gemini + スプレッドシート）

### UIフロー

#### 【金額訂正モード】
1. **ユーザー**：レシート画像を送る
2. **システム**：解析開始を通知
   - 「レシートを読み取っています…」と表示
3. **システム**：レシートの全解析結果を「テキスト形式」で表示し、アクションを求める
   - 本文：「店名、日時、品目、料金のリストと合計金額」のみを表示（説明文は一切含めない）
   - クイックリプライボタンを表示：[訂正] [仕分け]
4. **ユーザー**：ボタンを押す
   - **「仕分け」の場合**：以下の【仕分けモード】へ進む
   - **「訂正」の場合**：以下の手順5・6へ進む
5. **ユーザー（訂正時）**：金額の修正
   - 手順3でシステムが送ったリストをコピーし、誤っている箇所を直接編集してメッセージ送信
6. **システム**：訂正を反映し、再確認を求める
   - メッセージ1：「訂正を反映しました。以下ご確認ください」
   - メッセージ2：訂正後の「店名、日時、品目、料金のリストと合計金額」を左寄せのテキスト形式で送信
   - クイックリプライボタン（訂正、仕分け）を再表示

#### 【仕分けモード】
7. **以降**：全てが正しくなり「仕分け」を押した後は、1品目ずつの分類確定を行う（案2のフローへ）

### 処理フロー
1. **入力・解析**: LINEから画像を受信し、Geminiで構造化データ（品目リスト）化。
2. **確認用プレビュー**: ユーザーにテキスト形式で全品目リストを提示。
3. **訂正ループ**: ユーザーからテキスト送信（訂正）があった場合、その内容で内部データを上書きし、再度プレビュー提示。
4. **個別仕分け**: ユーザーが「仕分け」を承諾した後、1品目ずつクイックリプライで分類を確定。
5. **記録**: 最終的な結果をスプレッドシートに書き込み。

### 案2からの改善点
- **OCR精度の補完**: AIの読み書き間違い（特に数字）を、仕分け作業に入る前に一括で修正できるため、後の工程で混乱が生じない。
- **安心感**: 最初に全体像と合計金額を確認・修正できるため、データの正確性が担保しやすい。

## 案4：進捗可視化型仕分けUI（案3の拡張）

### 構成
案3と同様（LINE + n8n + Gemini + スプレッドシート）

### UIフロー
1. **ユーザー・システム**：案3の【金額訂正モード】（手順6）まで進む

#### 【仕分けモード（改善版）】
2. **システム**：1品目目の仕分けを求める際に、全体の進捗がわかるリストを提示
   - メッセージ1：「1品目目の仕分けをお願いします」
   - メッセージ2：以下の進捗絵文字付きリストを送信（左寄せ）
     - ➡️ 品目A：500（現在処理中）
     - 　 品目B：300
     - 　 品目C：200
   - クイックリプライボタンを表示：[🤝 割り勘] [🙋‍♂️ 自分] [🙋‍♀️ 妻] [保留]
3. **ユーザー**：ボタンを押す
4. **システム**：次の品目の仕分けを求める
   - メッセージ1：「2品目目の仕分けをお願いします」
   - メッセージ2：進捗を更新したリストを送信
     - 🤝 品目A：500（分類済み）
     - ➡️ 品目B：300（現在処理中）
     - 　 品目C：200
5. **以降**：全品目の仕分けが完了するまで繰り返し、最後に完了報告を表示

### 処理フロー
1. **進捗管理**: 内部で「未処理」「割り勘」「自分」「妻」のステータスを保持。
2. **リスト動的生成**: 1品目ごとに、現在のステータスに応じた絵文字を付与したリストテキストを生成し、ユーザーに送信。

### 案3からの改善点
- **現在地の把握**: 1品目ずつバラバラに届くのではなく、常に「レシート全体のどこを処理しているか」が可視化されるため、ユーザーの迷いがなくなる。
- **達成感**: 仕分けが進むにつれて絵文字が埋まっていくため、作業の進捗を実感しやすい。

## 案5：キャンセル機能と中断・再開フロー（案4の拡張）

### 構成
案4と同様（LINE + n8n + Gemini + スプレッドシート）

### UIフロー
1. **キャンセルボタンの常時表示**
   - 【金額訂正モード】および【仕分けモード】の全ステップにおけるクイックリプライに「❌ キャンセル」ボタンを追加。
2. **キャンセル実行時の挙動**
   - ユーザーが「キャンセル」を押すと、システムは「処理を中断しました。この明細は精算に加算されません」と通知。内部状態をクリアする。
3. **リスト送信による再開**
   - ユーザーが過去に送られた「品目リスト形式のテキスト（絵文字付き含む）」をメッセージとして送信。
   - 抽出される情報：
     - 店名、日時
     - 品目、金額
     - 各行の先頭にある絵文字（🤝、🙋‍♂️、🙋‍♀️、➡️ など）
4. **自動再開プロセス**
   - システムは受信したリストを解析し、現在地を判定して【金額訂正モード】または【仕分けモード】の該当ステップから再開。
   - ➡️ がついている品目、あるいは絵文字がついていない最初の品目からフローを再開。
   - すべての品目に分類済み絵文字がついている場合は、「全ての仕分けが完了しています。精算に加算しますか？」と再確認（二重計上防止）。

### 処理フロー
1. **メッセージ解析**: 受信メッセージが「レシートリスト形式」であるかを正規表現等で判定。
2. **ステート復元**: テキスト内の絵文字を解析し、どこまで分類が済んでいるかをDBなし（ステートレス）で復元。
3. **データ確定タイミング**: 全ての仕分けが完了した段階で初めてスプレッドシートに書き込みを行う（キャンセル時は書き込まない）。

### 案4からの改善点
- **柔軟な割り込み対応**: 外出先で仕分けを中断し、後で落ち着いてから過去のメッセージをコピペして再開するといった運用が可能になる。
- **誤操作防止**: 間違えて画像を送った場合や、解析が著しく誤っている場合に簡単に破棄できる。

## 問題点2の改善案

## 案1
問題点1解決案2のフローに組み込む形で、LINE通知とスプレッドシート共有により解決。

### スプレッドシート出力仕様

#### ブック名
`yyyy年_家庭内清算`
- 年ごとに1ブック作成

#### シート名
`mm`（例：01, 02, ... 12）
- 1ブックにつき12シート（1〜12月）

#### タイトル行
「清算額内訳」

#### 列構成
| 列 | 項目 |
|---|---|
| A | 日時 |
| B | 店名 |
| C | 金額 |

#### 最終行
合計（C列の合計値を表示）

## 案2（清算単位シート方式）
問題点1解決案2のフローに組み込む形で、LINE通知とスプレッドシート共有により解決。

### スプレッドシート出力仕様

#### ブック
- **1ブックのみ**（年単位で分けない）

#### シート
- **清算単位**で作成
- 新しい清算が発生するたびに新しいシートを作成

#### シート名
`清算_yyyymmdd`（例：清算_20241226）

### UIフロー

#### 常時表示
- LINE公式アカウントのリッチメニューに「📋 未清算分を確認」ボタンを常時表示

#### 未清算分の確認
1. **ユーザー**：「📋 未清算分を確認」ボタンをタップ
2. **システム**：現在の未清算シートの内容をテキスト形式でLINEに送信
   - 店名、日時、金額のリストと合計金額を表示
   - クイックリプライボタンを表示：[✅ 清算済みにする] [❌ キャンセル]
3. **ユーザー**：ボタンを押す
   - **「清算済みにする」の場合**：以下の清算確定フローへ
   - **「キャンセル」の場合**：何もせず終了

#### 清算の確定
1. **システム**：
   - 現在のシートを「清算済み」としてマーク（シート名を `清算済_yyyymmdd` に変更）
   - 以降の新規登録は新しいシートに記録
   - 「清算を確定しました。次回の登録は新しいシートに記録されます」と通知

## 問題点3の改善案

## 案1
問題点2の改善案2にて、「📋 未清算分を確認」ボタンタップ時に送信される未清算シートのテキストを共有することで解決。
