# ANALYSIS.md 改善提案書

> このドキュメントは、[ANALYSIS.md](./ANALYSIS.md) の内容をレビューした結果、発見された矛盾点・実現困難な点と、それに対する改善案を記載しています。

---

## 問題点1: スプレッドシートのデータモデルが不完全

### 元ファイルの該当箇所（抜粋）

> #### 列構成
> | 列 | 項目 |
> |---|---|
> | A | 日時 |
> | B | 店名 |
> | C | 金額 |
>
> #### 最終行
> 合計（C列の合計値を表示）

### なにが問題か

本システムの目的は「妻が支払う分の料金を計算して妻に伝える」ことです。品目ごとに「割り勘」「自分」「妻」と仕分けを行う機能がありますが、上記の列構成では以下の情報が記録できません：

1. **品目名**：どの商品が含まれているか不明
2. **分類**：各品目がどの分類に仕分けられたか不明
3. **妻負担額**：妻が支払うべき金額を算出する列がない

この構成では、仕分けを行っても結果を記録できず、清算時に表示される「合計金額」が総支出なのか妻負担額なのかも不明です。

### 代替案

列構成を以下のように拡張する：

| 列 | 項目 | 説明 |
|---|---|---|
| A | 日時 | 購入日時 |
| B | 店名 | 店舗名 |
| C | 品目 | 商品名 |
| D | 金額 | 購入金額 |
| E | 分類 | 「割り勘」「自分」「妻」のいずれか |
| F | 妻負担額 | 計算式：割り勘→D/2、妻→D、自分→0 |

最終行の「合計」はF列（妻負担額）の合計とし、これが清算金額となる。

---

## 問題点2: 案5の「ステートレス復元」は技術的に実現困難

### 元ファイルの該当箇所（抜粋）

> ### 処理フロー
> 2. **ステート復元**: テキスト内の絵文字を解析し、どこまで分類が済んでいるかをDBなし（ステートレス）で復元。

> ### UIフロー
> 3. **リスト送信による再開**
>    - ユーザーが過去に送られた「品目リスト形式のテキスト（絵文字付き含む）」をメッセージとして送信。

### なにが問題か

1. **店名・日時の欠落**：ユーザーが途中経過のリスト（絵文字付き）をコピペしても、元のレシートの店名・日時情報が含まれていない場合がある
2. **品目の一意性**：同じ金額の品目が複数ある場合（例：「品目A：500」が2つ）、テキストだけでは区別できない
3. **n8nの制約**：n8nはリクエストごとにステートレスで動作するため、セッション中の一時データ（OCR結果、仕分け途中の状態）を保持する仕組みが別途必要

### 代替案

「完全なステートレス復元」を諦め、セッション管理方式を採用する。

#### 改善案: セッション管理シートを利用

Google スプレッドシートに「セッション管理」シートを追加し、処理中のデータを一時保存する。

| 列 | 項目 |
|---|---|
| A | セッションID（LINEユーザーID） |
| B | ステータス（ocr_done / classifying / idle） |
| C | 品目データ（JSON形式） |
| D | 現在の品目インデックス |
| E | 最終更新日時 |

- 一定時間（例：24時間）経過したセッションは自動削除
- 過去のリストテキスト送信時は「新規入力」として処理（OCRをスキップして直接仕分けモードへ）

---

## 問題点3: 「妻が支払うべき金額」の計算ロジックが未定義

### 元ファイルの該当箇所（抜粋）

> 3. **ユーザー確認（クイックリプライ）**:
>     - LINEに「【品目A: 500円】の分類を選択してください（AI推論：割り勘）」のように届く。
>     - 下部に「割り勘」「自分負担」「妻負担」「保留」などのボタンを表示。

### なにが問題か

仕分けで「割り勘」「自分」「妻」を選択する機能はありますが、それぞれの選択に対してどのように「妻負担額」を計算するかが明記されていません。

特に「割り勘」の場合の端数処理（切り捨て or 切り上げ）が未定義です。

### 代替案

以下の計算ルールを明文化する：

| 分類 | 妻負担額の計算 |
|---|---|
| 🤝 割り勘 | 金額 ÷ 2（端数は切り捨て） |
| 🙋‍♂️ 自分 | 0円（私が全額負担） |
| 🙋‍♀️ 妻 | 金額の100%（妻が全額負担） |

端数処理の方針として「切り捨て」を採用（妻に有利な計算）。

---

## 問題点4: 初期シート作成タイミングが未定義

### 元ファイルの該当箇所（抜粋）

> #### 清算の確定
> 1. **システム**：
>    - 現在のシートを「清算済み」としてマーク（シート名を `清算済_yyyymmdd` に変更）
>    - 以降の新規登録は新しいシートに記録

### なにが問題か

「清算確定時に新シートを作成」とありますが、以下のケースでどのシートに記録するかが不明です：

1. システム初回利用時
2. 清算確定直後に最初のレシートを登録する場合

### 代替案

以下のルールを追加：

1. **初回利用時**：最初のレシート登録時に「清算_yyyymmdd」シートを自動作成
2. **清算確定直後**：清算確定処理内で新シートも同時に作成（次回登録先を確保）
3. **シート特定ロジック**：シート名が「清算_」で始まるシートのうち、最も日付が新しいものをアクティブシートとする
