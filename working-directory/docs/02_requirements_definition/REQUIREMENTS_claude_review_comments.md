# REQUIREMENTS.md 改善提案書

> このドキュメントは、[REQUIREMENTS.md](./REQUIREMENTS.md) の内容をレビューした結果、発見された矛盾点・実現困難な点と、それに対する改善案を記載しています。

---

## 問題点1: スプレッドシートの列構成が不完全

### 元ファイルの該当箇所（抜粋）

> ### 4.2 シート列構成
>
> | 列 | 項目 |
> |---|---|
> | A | 日時 |
> | B | 店名 |
> | C | 金額 |
> | 最終行 | 合計 |

### なにが問題か

品目ごとに「割り勘」「自分」「妻」と仕分けを行う機能がありますが、上記の列構成では以下の情報が記録できません：

1. **品目名**：どの商品が含まれているか
2. **分類**：各品目がどの分類に仕分けられたか
3. **妻負担額**：清算金額の根拠となる妻が支払うべき金額

最終行の「合計」も何を合計しているのか（総支出か妻負担額か）が不明です。

### 代替案

列構成を以下のように拡張する：

| 列 | 項目 | 説明 |
|---|---|---|
| A | 日時 | 購入日時 |
| B | 店名 | 店舗名 |
| C | 品目 | 商品名（一括登録時は空欄または「一括」） |
| D | 金額 | 購入金額 |
| E | 分類 | 「割り勘」「自分」「妻」のいずれか |
| F | 妻負担額 | 計算式：割り勘→D/2、妻→D、自分→0 |
| 最終行 | - | 合計（F列の合計＝清算金額） |

---

## 問題点2: F-08「過去明細修正」の実現方法が不明確

### 元ファイルの該当箇所（抜粋）

> | No | 機能名 | 概要 |
> |---|---|---|
> | F-08 | 過去明細修正 | 過去のリストを送信して中断箇所から再開 |

### なにが問題か

「過去のリストを送信して中断箇所から再開」という機能は、以下の理由で技術的に実現が困難です：

1. **ステートレス復元の限界**：ユーザーがコピペしたテキストから店名・日時を確実に抽出できない場合がある
2. **品目の一意性**：同じ金額の品目が複数ある場合、テキストだけでは区別できない
3. **n8nの制約**：n8nはリクエストごとにステートレスで動作するため、別途セッション管理が必要

### 代替案

F-08の概要を以下に修正：

| 変更前 | 変更後 |
|---|---|
| 過去のリストを送信して中断箇所から再開 | セッション管理により中断箇所から再開（24時間有効）。過去のリストテキスト送信時は新規入力として処理 |

セッション管理はスプレッドシートで行い、ユーザーIDごとに処理中のデータを一時保存する。

---

## 問題点3: F-11「データ記録」の記録項目が不足

### 元ファイルの該当箇所（抜粋）

> | No | 機能名 | 概要 |
> |---|---|---|
> | F-11 | データ記録 | スプレッドシートに日時・店名・金額を記録 |

### なにが問題か

「日時・店名・金額」の3項目のみでは、仕分け結果（分類）と妻負担額が記録されません。これではシステムの目的である「妻が支払う分の料金を計算する」ことができません。

### 代替案

F-11の概要を以下に修正：

| 変更前 | 変更後 |
|---|---|
| スプレッドシートに日時・店名・金額を記録 | スプレッドシートに日時・店名・品目・金額・分類・妻負担額を記録 |

---

## 問題点4: 妻負担額の計算ルールが未定義

### 元ファイルの該当箇所（抜粋）

（REQUIREMENTS.mdには計算ルールの記載なし）

### なにが問題か

仕分けで「割り勘」「自分」「妻」を選択できますが、それぞれの選択に対してどのように「妻負担額」を計算するかが明記されていません。

特に「割り勘」の場合の端数処理が未定義です。

### 代替案

以下のセクションを追加する：

```
### 4.3 妻負担額の計算ルール

| 分類 | 計算式 | 例（金額=1,000円） |
|---|---|---|
| 🤝 割り勘 | 金額 ÷ 2（切り捨て） | 500円 |
| 🙋‍♂️ 自分 | 0 | 0円 |
| 🙋‍♀️ 妻 | 金額 × 1 | 1,000円 |
```
