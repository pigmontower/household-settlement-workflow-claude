# åŸºæœ¬è¨­è¨ˆæ›¸ï¼ˆBasic Designï¼‰

## 1. ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

### 1.1 å…¨ä½“æ§‹æˆå›³

```mermaid
graph TB
    subgraph ãƒ¦ãƒ¼ã‚¶ãƒ¼
        LINE[LINE ã‚¢ãƒ—ãƒª]
    end

    subgraph LINE Platform
        LINEAPI[LINE Messaging API]
        WEBHOOK[Webhook]
    end

    subgraph Backend ["ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (n8n)"]
        N8N[n8n ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼]
        STATE[ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ç®¡ç†]
    end

    subgraph AI
        GEMINI[Gemini 1.5 Flash]
    end

    subgraph Data
        SHEET[Google ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ]
    end

    LINE --> LINEAPI
    LINEAPI --> WEBHOOK
    WEBHOOK --> N8N
    N8N --> GEMINI
    N8N --> SHEET
    N8N --> LINEAPI
    LINEAPI --> LINE
```

### 1.2 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | æŠ€è¡“/ã‚µãƒ¼ãƒ“ã‚¹ | å½¹å‰² |
|---|---|---|
| LINE Messaging API | LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€å—ä¿¡ |
| n8n | ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆ or ã‚¯ãƒ©ã‚¦ãƒ‰ | ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡ã€APIé€£æº |
| Gemini 1.5 Flash | Google AI | OCRè§£æã€ãƒ†ã‚­ã‚¹ãƒˆæ§‹é€ åŒ– |
| Google ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ | Google Workspace | ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–ã€é›†è¨ˆ |

---

## 2. ç”»é¢è¨­è¨ˆ

### 2.1 LINE ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼

| ãƒœã‚¿ãƒ³ | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ |
|---|---|
| ğŸ“‹ æœªæ¸…ç®—åˆ†ã‚’ç¢ºèª | æœªæ¸…ç®—ã‚·ãƒ¼ãƒˆã®å†…å®¹ã‚’ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º |

### 2.2 ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤ãƒœã‚¿ãƒ³ä¸€è¦§

| ç”»é¢ | ãƒœã‚¿ãƒ³ | èª¬æ˜ |
|---|---|---|
| è§£æçµæœè¡¨ç¤ºå¾Œ | [è¨‚æ­£] [ä»•åˆ†ã‘] [å…¨ã¦å‰²ã‚Šå‹˜ã§ç™»éŒ²] | è¨‚æ­£ï¼šãƒ†ã‚­ã‚¹ãƒˆä¿®æ­£ã€ä»•åˆ†ã‘ï¼šå“ç›®åˆ¥åˆ†é¡ã€å…¨ã¦å‰²ã‚Šå‹˜ã§ç™»éŒ²ï¼šå…¨å“ç›®ã‚’å‰²ã‚Šå‹˜ã§ä¸€æ‹¬ç™»éŒ² |
| ä»•åˆ†ã‘ãƒ¢ãƒ¼ãƒ‰ | [ğŸ¤ å‰²ã‚Šå‹˜] [ğŸ™‹â€â™‚ï¸ è‡ªåˆ†] [ğŸ™‹â€â™€ï¸ å¦»] [âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«] | å“ç›®ã”ã¨ã«è² æ‹…è€…ã‚’é¸æŠ |
| æœªæ¸…ç®—ç¢ºèªå¾Œ | [âœ… æ¸…ç®—æ¸ˆã¿ã«ã™ã‚‹] [âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«] | æ¸…ç®—ç¢ºå®šã§ã‚·ãƒ¼ãƒˆåã‚’å¤‰æ›´ã—æ–°ã‚·ãƒ¼ãƒˆä½œæˆ |

### 2.3 ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

#### è§£æçµæœãƒ†ã‚­ã‚¹ãƒˆ
```
ã‚¹ãƒ¼ãƒ‘ãƒ¼ABC
2024/12/27 10:30
----------------
å“ç›®Aï¼š500
å“ç›®Bï¼š300
å“ç›®Cï¼š200
----------------
åˆè¨ˆï¼š1,000
```

#### ä»•åˆ†ã‘é€²æ—è¡¨ç¤º
```
ã‚¹ãƒ¼ãƒ‘ãƒ¼ABC
2024/12/27 10:30
----------------
ğŸ¤ å“ç›®Aï¼š500
â¡ï¸ å“ç›®Bï¼š300
ã€€ å“ç›®Cï¼š200
----------------
åˆè¨ˆï¼š1,000
```

#### æœªæ¸…ç®—ãƒªã‚¹ãƒˆè¡¨ç¤º
```
ã€æ¸…ç®—é¡å†…è¨³ã€‘

2024/12/20 ã‚¹ãƒ¼ãƒ‘ãƒ¼ABC
â†’ 1,500å††

2024/12/22 ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢XYZ
â†’ 800å††

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
åˆè¨ˆï¼š2,300å††
```

---

## 3. ãƒ‡ãƒ¼ã‚¿è¨­è¨ˆ

### 3.1 ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ§‹æˆ

| é …ç›® | ä»•æ§˜ |
|---|---|
| ãƒ–ãƒƒã‚¯å | `å®¶åº­å†…æ¸…ç®—` |
| ãƒ–ãƒƒã‚¯æ•° | 1ãƒ–ãƒƒã‚¯ã®ã¿ |
| ã‚·ãƒ¼ãƒˆ | æ¸…ç®—å˜ä½ã§å‹•çš„ä½œæˆ |

### 3.2 ã‚·ãƒ¼ãƒˆå‘½åè¦å‰‡

| çŠ¶æ…‹ | ã‚·ãƒ¼ãƒˆå | ä¾‹ |
|---|---|---|
| æœªæ¸…ç®—ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼‰ | `æ¸…ç®—_yyyymmdd` | æ¸…ç®—_20241227 |
| æ¸…ç®—æ¸ˆã¿ | `æ¸…ç®—æ¸ˆ_yyyymmdd` | æ¸…ç®—æ¸ˆ_20241227 |

### 3.3 ã‚·ãƒ¼ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

| è¡Œ | Aåˆ—ï¼ˆæ—¥æ™‚ï¼‰ | Båˆ—ï¼ˆåº—åï¼‰ | Cåˆ—ï¼ˆé‡‘é¡ï¼‰ |
|---|---|---|---|
| 1 | **æ—¥æ™‚** | **åº—å** | **é‡‘é¡** |
| 2 | 2024/12/20 10:30 | ã‚¹ãƒ¼ãƒ‘ãƒ¼ABC | 1,500 |
| 3 | 2024/12/22 14:00 | ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢XYZ | 800 |
| ... | ... | ... | ... |
| æœ€çµ‚è¡Œ | | **åˆè¨ˆ** | =SUM(C2:C_n) |

---

## 4. ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³

### 4.1 æ˜ç´°ç™»éŒ²ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    actor ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant LINE as LINE API
    participant N8N as n8n
    participant GEMINI as Gemini
    participant SHEET as ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ

    ãƒ¦ãƒ¼ã‚¶ãƒ¼->>LINE: ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒé€ä¿¡
    LINE->>N8N: Webhook (ç”»åƒãƒ‡ãƒ¼ã‚¿)
    N8N->>GEMINI: OCRè§£æãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    GEMINI-->>N8N: è§£æçµæœ (JSON)
    N8N->>LINE: è§£æçµæœãƒ†ã‚­ã‚¹ãƒˆé€ä¿¡
    LINE-->>ãƒ¦ãƒ¼ã‚¶ãƒ¼: ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º
    N8N->>LINE: ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤é€ä¿¡
    LINE-->>ãƒ¦ãƒ¼ã‚¶ãƒ¼: ãƒœã‚¿ãƒ³è¡¨ç¤º

    alt è¨‚æ­£
        ãƒ¦ãƒ¼ã‚¶ãƒ¼->>LINE: ä¿®æ­£ãƒ†ã‚­ã‚¹ãƒˆé€ä¿¡
        LINE->>N8N: Webhook (ãƒ†ã‚­ã‚¹ãƒˆ)
        N8N->>N8N: ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        N8N->>LINE: åæ˜ çµæœé€ä¿¡
    end

    alt ä»•åˆ†ã‘
        loop å…¨å“ç›®
            ãƒ¦ãƒ¼ã‚¶ãƒ¼->>LINE: åˆ†é¡ãƒœã‚¿ãƒ³æŠ¼ä¸‹
            LINE->>N8N: Webhook (postback)
            N8N->>N8N: åˆ†é¡ãƒ‡ãƒ¼ã‚¿æ›´æ–°
            N8N->>LINE: æ¬¡å“ç›®è¡¨ç¤º
        end
        N8N->>SHEET: ä»•åˆ†ã‘çµæœæ›¸ãè¾¼ã¿
    end

    alt ç™»éŒ²
        ãƒ¦ãƒ¼ã‚¶ãƒ¼->>LINE: ç™»éŒ²ãƒœã‚¿ãƒ³æŠ¼ä¸‹
        LINE->>N8N: Webhook (postback)
        N8N->>SHEET: æ˜ç´°æ›¸ãè¾¼ã¿
    end

    SHEET-->>N8N: æ›¸ãè¾¼ã¿å®Œäº†
    N8N->>LINE: å®Œäº†é€šçŸ¥
    LINE-->>ãƒ¦ãƒ¼ã‚¶ãƒ¼: å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
```

### 4.2 æ¸…ç®—ç¢ºèªãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    actor ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant LINE as LINE API
    participant N8N as n8n
    participant SHEET as ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ

    ãƒ¦ãƒ¼ã‚¶ãƒ¼->>LINE: ã€Œæœªæ¸…ç®—åˆ†ã‚’ç¢ºèªã€ã‚¿ãƒƒãƒ—
    LINE->>N8N: Webhook (postback)
    N8N->>SHEET: æœªæ¸…ç®—ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿
    SHEET-->>N8N: ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿
    N8N->>N8N: ãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢
    N8N->>LINE: æœªæ¸…ç®—ãƒªã‚¹ãƒˆé€ä¿¡
    LINE-->>ãƒ¦ãƒ¼ã‚¶ãƒ¼: ãƒªã‚¹ãƒˆè¡¨ç¤º
    N8N->>LINE: ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ—ãƒ©ã‚¤é€ä¿¡
    LINE-->>ãƒ¦ãƒ¼ã‚¶ãƒ¼: ãƒœã‚¿ãƒ³è¡¨ç¤º

    alt æ¸…ç®—ç¢ºå®š
        ãƒ¦ãƒ¼ã‚¶ãƒ¼->>LINE: ã€Œæ¸…ç®—æ¸ˆã¿ã«ã™ã‚‹ã€æŠ¼ä¸‹
        LINE->>N8N: Webhook (postback)
        N8N->>SHEET: ã‚·ãƒ¼ãƒˆåå¤‰æ›´ (æ¸…ç®—æ¸ˆ_yyyymmdd)
        N8N->>SHEET: æ–°ã‚·ãƒ¼ãƒˆä½œæˆ (æ¸…ç®—_yyyymmdd)
        SHEET-->>N8N: å‡¦ç†å®Œäº†
        N8N->>LINE: å®Œäº†é€šçŸ¥
        LINE-->>ãƒ¦ãƒ¼ã‚¶ãƒ¼: å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    end
```

---

## 5. n8n ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ

### 5.1 ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¸€è¦§

| No | ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å | ãƒˆãƒªã‚¬ãƒ¼ | æ¦‚è¦ |
|---|---|---|---|
| WF-01 | LINE Webhook Handler | LINE Webhook | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡æ™‚ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° |
| WF-02 | Receipt OCR | WF-01 ã‹ã‚‰å‘¼ã³å‡ºã— | ç”»åƒè§£æãƒ»ãƒ†ã‚­ã‚¹ãƒˆåŒ– |
| WF-03 | Item Classification | WF-01 ã‹ã‚‰å‘¼ã³å‡ºã— | å“ç›®ä»•åˆ†ã‘å‡¦ç† |
| WF-04 | Settlement Check | WF-01 ã‹ã‚‰å‘¼ã³å‡ºã— | æœªæ¸…ç®—ç¢ºèªãƒ»æ¸…ç®—ç¢ºå®š |

### 5.2 ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ç®¡ç†

| çŠ¶æ…‹ | èª¬æ˜ |
|---|---|
| `idle` | å¾…æ©Ÿä¸­ |
| `ocr_done` | OCRå®Œäº†ã€è¨‚æ­£/ä»•åˆ†ã‘å¾…ã¡ |
| `classifying` | ä»•åˆ†ã‘ä¸­ï¼ˆå“ç›®indexä¿æŒï¼‰ |

---

## 6. APIè¨­è¨ˆ

### 6.1 LINE Messaging API

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ç”¨é€” |
|---|---|
| `POST /v2/bot/message/reply` | ãƒªãƒ—ãƒ©ã‚¤ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ |
| `POST /v2/bot/message/push` | ãƒ—ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ |
| `GET /v2/bot/message/{messageId}/content` | ç”»åƒã‚³ãƒ³ãƒ†ãƒ³ãƒ„å–å¾— |

### 6.2 Gemini API

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ç”¨é€” |
|---|---|
| `POST /v1/models/gemini-1.5-flash:generateContent` | OCRè§£æ |

### 6.3 Google Sheets API

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ç”¨é€” |
|---|---|
| `GET /v4/spreadsheets/{id}/values/{range}` | ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ |
| `POST /v4/spreadsheets/{id}/values/{range}:append` | è¡Œè¿½åŠ  |
| `POST /v4/spreadsheets/{id}:batchUpdate` | ã‚·ãƒ¼ãƒˆåå¤‰æ›´ã€æ–°è¦ä½œæˆ |
