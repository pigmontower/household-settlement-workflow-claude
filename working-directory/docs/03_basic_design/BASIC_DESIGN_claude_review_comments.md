# BASIC_DESIGN.md 改善提案書

> このドキュメントは、[BASIC_DESIGN.md](./BASIC_DESIGN.md) の内容をレビューした結果、発見された矛盾点・実現困難な点と、それに対する改善案を記載しています。

---

## 問題点1: シートレイアウトの列構成が不完全

### 元ファイルの該当箇所（抜粋）

> ### 3.3 シートレイアウト
>
> | 行 | A列（日時） | B列（店名） | C列（金額） |
> |---|---|---|---|
> | 1 | **日時** | **店名** | **金額** |
> | 2 | 2024/12/20 10:30 | スーパーABC | 1,500 |
> | 3 | 2024/12/22 14:00 | ドラッグストアXYZ | 800 |
> | ... | ... | ... | ... |
> | 最終行 | | **合計** | =SUM(C2:C_n) |

### なにが問題か

品目ごとに仕分けを行う機能（F-05）があるにもかかわらず、シートレイアウトには以下の列が不足しています：

1. **品目（C列）**：どの商品かを記録できない
2. **分類（E列）**：「割り勘」「自分」「妻」のどれに分類したか記録できない
3. **妻負担額（F列）**：清算金額の根拠となる妻の支払い額を記録できない

最終行の合計が `=SUM(C2:C_n)` となっていますが、これは総支出の合計であり、妻が支払うべき清算金額ではありません。

### 代替案

シートレイアウトを以下のように拡張する：

| 行 | A列（日時） | B列（店名） | C列（品目） | D列（金額） | E列（分類） | F列（妻負担額） |
|---|---|---|---|---|---|---|
| 1 | **日時** | **店名** | **品目** | **金額** | **分類** | **妻負担額** |
| 2 | 2024/12/20 10:30 | スーパーABC | 牛乳 | 200 | 割り勘 | 100 |
| 3 | 2024/12/20 10:30 | スーパーABC | ビール | 500 | 自分 | 0 |
| 4 | 2024/12/22 14:00 | ドラッグストアXYZ | 一括 | 800 | 割り勘 | 400 |
| ... | ... | ... | ... | ... | ... | ... |
| 最終行 | | | | **合計** | | =SUM(F2:F_n) |

---

## 問題点2: 未清算リスト表示に妻負担額が含まれていない

### 元ファイルの該当箇所（抜粋）

> #### 未清算リスト表示
> ```
> 【清算額内訳】
>
> 2024/12/20 スーパーABC
> → 1,500円
>
> 2024/12/22 ドラッグストアXYZ
> → 800円
>
> ────────────
> 合計：2,300円
> ```

### なにが問題か

表示されている金額が「購入金額の合計」なのか「妻負担額の合計」なのかが不明です。

システムの目的は「妻が支払う分の料金を計算して妻に伝える」ことですので、表示されるべきは「妻負担額」です。

### 代替案

未清算リスト表示を以下のように改善する：

```
【清算額内訳】

2024/12/20 スーパーABC
購入金額：1,800円 → 妻負担：750円

2024/12/22 ドラッグストアXYZ
購入金額：800円 → 妻負担：400円

────────────
妻負担合計：1,150円
```

または簡略版として：

```
【清算額内訳】

2024/12/20 スーパーABC → 750円
2024/12/22 ドラッグストアXYZ → 400円

────────────
合計：1,150円（妻負担額）
```

---

## 問題点3: セッション管理の保存先が未定義

### 元ファイルの該当箇所（抜粋）

> ### 5.2 セッション状態管理
>
> | 状態 | 説明 |
> |---|---|
> | `idle` | 待機中 |
> | `ocr_done` | OCR完了、訂正/仕分け待ち |
> | `classifying` | 仕分け中（品目index保持） |

### なにが問題か

セッション状態（idle / ocr_done / classifying）をどこに保存するかが明記されていません。

n8nはリクエストごとにステートレスで動作するため、セッション状態を永続化する仕組みが必要です。

### 代替案

Google スプレッドシートに「セッション管理」シートを追加する設計を明記：

| 列 | 項目 | 説明 |
|---|---|---|
| A | セッションID | LINEユーザーID |
| B | ステータス | idle / ocr_done / classifying |
| C | 品目データ | OCR結果をJSON形式で保持 |
| D | 現在インデックス | 仕分け中の品目番号 |
| E | 最終更新日時 | タイムアウト判定用 |

セッションの有効期限は24時間とし、古いセッションは自動削除する。

---

## 問題点4: 「登録」ボタン押下時の処理フローが未記載

### 元ファイルの該当箇所（抜粋）

> ### 4.1 明細登録フロー
> ```
>     alt 登録
>         ユーザー->>LINE: 登録ボタン押下
>         LINE->>N8N: Webhook (postback)
>         N8N->>SHEET: 明細書き込み
>     end
> ```

### なにが問題か

「明細書き込み」と記載されていますが、仕分けを行っていない場合にどのような値で書き込むかが不明です。

### 代替案

「登録」ボタンは「全品目を割り勘として一括登録」する簡易モードとして定義：

```
    alt 登録（全品目を割り勘として一括登録）
        ユーザー->>LINE: 登録ボタン押下
        LINE->>N8N: Webhook (postback)
        N8N->>N8N: 全品目に分類「割り勘」を設定
        N8N->>N8N: 妻負担額を計算（合計金額 ÷ 2）
        N8N->>SHEET: 明細書き込み（品目は「一括」）
    end
```

---

## 問題点5: 解析結果テキストに「登録」ボタンがない

### 元ファイルの該当箇所（抜粋）

> ### 2.2 クイックリプライボタン一覧
>
> | 画面 | ボタン |
> |---|---|
> | 解析結果表示後 | [訂正] [仕分け] [登録] |

### なにが問題か

クイックリプライボタン一覧には「登録」ボタンが記載されていますが、「2.3 メッセージフォーマット」の解析結果テキストの例には対応するボタンの説明がありません。

また、UIモックアップ（case3）には「訂正」「仕分けへ」の2ボタンしか表示されておらず、「登録」ボタンが存在しません。

### 代替案

モックアップを更新し、「登録」ボタンを追加する。詳細は mockups の _improvement.html を参照。
