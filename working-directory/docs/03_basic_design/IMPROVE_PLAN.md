# 基本設計書 改善計画

> このドキュメントは、[BASIC_DESIGN_claude_review_comments.md](./BASIC_DESIGN_claude_review_comments.md) のレビュー指摘に基づく改善計画を記載しています。

---

## 改善項目1: シートレイアウトの列構成拡張

### 現状の課題

品目ごとに仕分けを行う機能があるにもかかわらず、シートレイアウトには以下の列が不足している：

1. **品目（C列）**：どの商品かを記録できない
2. **分類（E列）**：「割り勘」「自分」「妻」のどれに分類したか記録できない
3. **妻負担額（F列）**：清算金額の根拠となる妻の支払い額を記録できない

### 改善案

シートレイアウトを以下のように拡張する：

| 行 | A列（日時） | B列（店名） | C列（品目） | D列（金額） | E列（分類） | F列（妻負担額） |
|---|---|---|---|---|---|---|
| 1 | **日時** | **店名** | **品目** | **金額** | **分類** | **妻負担額** |
| 2 | 2024/12/20 10:30 | スーパーABC | 牛乳 | 200 | 割り勘 | 100 |
| 3 | 2024/12/20 10:30 | スーパーABC | ビール | 500 | 自分 | 0 |
| 4 | 2024/12/22 14:00 | ドラッグストアXYZ | 一括 | 800 | 割り勘 | 400 |
| ... | ... | ... | ... | ... | ... | ... |
| 最終行 | | | | **合計** | | =SUM(F2:F_n) |

> **分類の種類と妻負担額の計算**
> - 割り勘：妻負担額 = 金額 ÷ 2
> - 自分：妻負担額 = 0
> - 妻：妻負担額 = 金額

---

## 改善項目2: 未清算リスト表示に妻負担額を追加

### 現状の課題

表示されている金額が「購入金額の合計」なのか「妻負担額の合計」なのかが不明。

### 改善案

未清算リスト表示を以下のように改善する：

```
【清算額内訳】

2024/12/20 スーパーABC
購入金額：1,800円 → 妻負担：750円

2024/12/22 ドラッグストアXYZ
購入金額：800円 → 妻負担：400円

────────────
妻負担合計：1,150円
```

---

## 改善項目3: セッション管理シートの追加

### 現状の課題

セッション状態（idle / ocr_done / classifying）をどこに保存するかが明記されていない。n8nはリクエストごとにステートレスで動作するため、セッション状態を永続化する仕組みが必要。

### 改善案

Google スプレッドシートに「セッション管理」シートを追加する：

| 列 | 項目 | 説明 |
|---|---|---|
| A | セッションID | LINEユーザーID |
| B | ステータス | idle / ocr_done / classifying |
| C | 品目データ | OCR結果をJSON形式で保持 |
| D | 現在インデックス | 仕分け中の品目番号 |
| E | 最終更新日時 | タイムアウト判定用 |

> **セッション有効期限**
> - 有効期限：24時間
> - 古いセッションは自動削除する

---

## 改善項目4: 「登録」ボタン押下時の処理フロー詳細化

### 現状の課題

シーケンス図の「明細書き込み」部分で、仕分けを行っていない場合にどのような値で書き込むかが不明。

### 改善案

「登録」ボタンは「全品目を割り勘として一括登録」する簡易モードとして定義：

```mermaid
sequenceDiagram
    alt 登録（全品目を割り勘として一括登録）
        ユーザー->>LINE: 登録ボタン押下
        LINE->>N8N: Webhook (postback)
        N8N->>N8N: 全品目に分類「割り勘」を設定
        N8N->>N8N: 妻負担額を計算（合計金額 ÷ 2）
        N8N->>SHEET: 明細書き込み（品目は「一括」）
    end
```
